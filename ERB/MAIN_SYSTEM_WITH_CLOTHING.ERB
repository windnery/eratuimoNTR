; 主系统集成服装系统
@MAIN_SYSTEM_WITH_CLOTHING
; 游戏主循环 - 集成服装系统

; 初始化检查
IF FLAG:90 == 0
	CALL INIT_DECLINE_SYSTEM
	FLAG:90 = 1
ENDIF

; 服装系统初始化
IF FLAG:91 == 0
	CALL INIT_CLOTHING_SYSTEM
ENDIF

$MAIN_LOOP_CLOTHING
CLEARLINE 1
PRINTL 【昙明学院 - 第{FLAG:43}天】
PRINTL 【当前位置：{GET_LOCATION_NAME()}】
PRINTL 【状态：好感度:{FLAG:38} 背德值:{FLAG:39} NTR进度:{GET_TOTAL_NTR_PROGRESS()}%】

; 显示身体状态摘要
IF FLAG:72 == 1  ; 女性线
	PRINTFORML 【身体：胸部{GET_BREAST_SIZE_TEXT(1)} 小穴{GET_VAGINA_SIZE_TEXT(1)} 淫乱度:{GET_PALAM(1, 20)}】
	PRINTFORML 【穿着：{GET_CLOTHING_NAME(GET_EQUIP(1))}+{GET_CLOTHING_NAME(GET_EQUIP(2))} 性感度:{CALCULATE_SEXY_SCORE()}】
ENDIF

PRINTL 
PRINTL 【请选择行动】
PRINTL [1] 探索学院
PRINTL [2] 寻找角色
PRINTL [3] 查看状态
PRINTL [4] 查看身体状态
PRINTL [5] 查看堕落状态
PRINTL [6] 查看服装状态
PRINTL [7] 更换服装
PRINTL [8] 休息
PRINTL [0] 返回标题

$MAIN_INPUT_CLOTHING
INPUT

IF RESULT == 0
	GOTO SYSTEM_TITLE
ELSEIF RESULT == 1
	GOSUB EXPLORE_COLLEGE_WITH_CLOTHING
	CLEARLINE 10
	GOTO MAIN_LOOP_CLOTHING
ELSEIF RESULT == 2
	GOSUB FIND_CHARACTER
	CLEARLINE 10
	GOTO MAIN_LOOP_CLOTHING
ELSEIF RESULT == 3
	GOSUB VIEW_STATUS_ENHANCED
	CLEARLINE 20
	GOTO MAIN_LOOP_CLOTHING
ELSEIF RESULT == 4
	GOSUB VIEW_BODY_STATUS
	CLEARLINE 20
	GOTO MAIN_LOOP_CLOTHING
ELSEIF RESULT == 5
	GOSUB VIEW_DECLINE_STATUS
	CLEARLINE 20
	GOTO MAIN_LOOP_CLOTHING
ELSEIF RESULT == 6
	GOSUB VIEW_CLOTHING_STATUS
	CLEARLINE 20
	GOTO MAIN_LOOP_CLOTHING
ELSEIF RESULT == 7
	GOSUB CHANGE_CLOTHING_MENU
	CLEARLINE 10
	GOTO MAIN_LOOP_CLOTHING
ELSEIF RESULT == 8
	GOSUB REST_WITH_CLOTHING
	CLEARLINE 10
	GOTO MAIN_LOOP_CLOTHING
ELSE
	CLEARLINE 1
	GOTO MAIN_INPUT_CLOTHING
ENDIF

@EXPLORE_COLLEGE_WITH_CLOTHING
; 探索学院 - 带服装效果
GOSUB EXPLORE_COLLEGE

; 应用性感度效果
CALL APPLY_SEXY_EFFECTS

; 根据性感度增加随机事件
LOCAL = CALCULATE_SEXY_SCORE()

IF LOCAL >= 70 AND RAND:100 < 20
	; 触发服装相关事件
	GOSUB CLOTHING_RELATED_EVENT
ENDIF

RETURN

@CLOTHING_RELATED_EVENT
; 服装相关事件
LOCAL = RAND:100

IF LOCAL < 30
	; 服装被注意到
	GOSUB CLOTHING_NOTICED_EVENT
ELSEIF LOCAL < 60
	; 服装引发讨论
	GOSUB CLOTHING_TALK_EVENT
ELSEIF LOCAL < 80
	; 服装导致意外
	GOSUB CLOTHING_ACCIDENT_EVENT
ELSE
	; 服装被损坏
	GOSUB CLOTHING_DAMAGE_EVENT
ENDIF

RETURN

@CLOTHING_NOTICED_EVENT
; 服装被注意到事件
PRINTL 
PRINTL 【有人注意到了你的穿着...】
WAIT

LOCAL = GET_CHEST_EXPOSURE_LEVEL()

IF LOCAL >= 2
	PRINTL 女生A：你看那个女生，胸部都露出来了...
	PRINTL 女生B：真是不知羞耻...
	PRINTFORML %CALLNAME:(1)%：（听到议论，赶紧捂住胸口）
	PRINTL 但已经有很多人看到了。
	FLAG:100 += 15
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 20, 2
ELSEIF GET_CROTCH_EXPOSURE_LEVEL() >= 2
	PRINTL 女生C：裙子那么短，内裤都看到了...
	PRINTL 女生D：肯定是故意的...
	PRINTFORML %CALLNAME:(1)%：（试图拉下裙子，但太短了拉不下来）
	FLAG:100 += 18
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 22, 2
ELSEIF FLAG:96 == 1  ; 湿身
	PRINTL 男生A：看那边，衣服都湿透了...
	PRINTL 男生B：内衣都看得清清楚楚...
	PRINTFORML %CALLNAME:(1)%：（抱着身体想要遮挡）
	PRINTL 但湿透的衣服紧贴在身上，反而更明显了。
	FLAG:100 += 20
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 25, 2
ELSE
	PRINTL 老师：%CALLNAME:(1)%同学，你的穿着有点...
	PRINTFORML %CALLNAME:(1)%：对、对不起老师...
	PRINTL 老师：下次注意一点，学院有仪容规定。
	FLAG:100 += 8
ENDIF

WAIT
RETURN

@CLOTHING_TALK_EVENT
; 服装引发讨论事件
PRINTL 
PRINTL 【你听到几个学生在议论你的穿着...】
WAIT

LOCAL = RAND:3

IF LOCAL == 0
	PRINTL 学生A：她今天穿得好性感啊...
	PRINTL 学生B：是啊，平时都没注意她身材这么好。
	PRINTL 学生C：是不是有男朋友了？所以开始打扮了？
	PRINTFORML %CALLNAME:(1)%：（脸红着快步走开）
	FLAG:100 += 12
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 10, 1
ELSEIF LOCAL == 1
	PRINTL 女生A：穿成这样是想勾引男生吧？
	PRINTL 女生B：就是，装什么清纯...
	PRINTL 女生C：听说她跟好几个男生走得很近...
	PRINTFORML %CALLNAME:(1)%：（委屈地低下头）
	FLAG:100 += 10
	CALL SET_PALAM, 1, 16, MIN(100, GET_PALAM(1, 16) + 8)  ; 背德感增加
ELSE
	PRINTL 男生A：那女的真骚，穿成那样...
	PRINTL 男生B：要不要去搭讪试试？
	PRINTL 男生C：算了吧，听说她很难搞...
	PRINTFORML %CALLNAME:(1)%：（感到不安）
	FLAG:100 += 15
	CALL SET_PALAM, 1, 41, MIN(100, GET_PALAM(1, 41) + 5)  ; 不安感增加
ENDIF

; 可能触发后续事件
IF CALCULATE_SEXY_SCORE() >= 90 AND RAND:100 < 30
	PRINTL 
	PRINTL 【议论你的那些人开始跟了过来...】
	GOSUB RANDOM_STALKING_EVENT
ENDIF

WAIT
RETURN

@CLOTHING_ACCIDENT_EVENT
; 服装导致意外事件
PRINTL 
PRINTL 【因为穿着问题，发生了意外...】
WAIT

LOCAL = RAND:100

IF LOCAL < 40
	; 裙子被勾住
	GOSUB SKIRT_CAUGHT_EVENT
ELSEIF LOCAL < 70
	; 上衣被弄湿
	GOSUB TOP_WET_EVENT
ELSE
	; 鞋子出现问题
	GOSUB SHOE_PROBLEM_EVENT
ENDIF

RETURN

@SKIRT_CAUGHT_EVENT
; 裙子被勾住事件
PRINTL 【你的裙子被什么东西勾住了...】
WAIT

PRINTFORML %CALLNAME:(1)%：啊！裙子...
PRINTL 裙子被钩子勾住，向上掀了起来。
PRINTL 内裤完全暴露在众人面前。
PRINTL 
PRINTL 【很多人看到了这一幕...】
WAIT

CALL UPDATE_CLOTHING_VISIBILITY, 1, 0  ; 裙子被掀起

IF GET_EQUIP(6) == 0  ; 没穿内裤
	PRINTL 学生A：哇！没穿内裤！
	PRINTL 学生B：真的假的？让我看看！
	PRINTFORML %CALLNAME:(1)%：（赶紧捂住私处）不、不要看！
	FLAG:100 += 35
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 30, 3
ELSEIF GET_EQUIP(6) >= 604  ; 蕾丝或更性感的内裤
	PRINTL 学生C：内裤好性感啊...
	PRINTL 学生D：果然是故意的...
	PRINTFORML %CALLNAME:(1)%：（拼命拉下裙子）不是的！意外！
	FLAG:100 += 28
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 25, 3
ELSE
	PRINTL 老师：%CALLNAME:(1)%同学，注意一下！
	PRINTFORML %CALLNAME:(1)%：对、对不起！是意外！
	PRINTL 你赶紧解开了裙子，但已经有很多人看到了。
	FLAG:100 += 20
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 18, 2
ENDIF

; 可能有人拍照
IF RAND:100 < 40
	PRINTL 
	PRINTL 【有人拿出手机拍照了...】
	PRINTFORML %CALLNAME:(1)%：不、不要拍！
	PRINTL 但闪光灯已经闪过了。
	CALL SET_PALAM, 1, 33, GET_PALAM(1, 33) + 15  ; 羞辱经验增加
ENDIF

WAIT
RETURN

@TOP_WET_EVENT
; 上衣被弄湿事件
PRINTL 【有人不小心把饮料洒在你身上...】
WAIT

PRINTL 男生：对不起对不起！我不是故意的！
PRINTL 但他把整杯饮料都倒在了你胸前。
PRINTFORML %CALLNAME:(1)%：啊！衣服都湿了...
PRINTL 上衣湿透后变得透明，内衣清晰可见。
PRINTL 
PRINTL 【很多人盯着你看...】
WAIT

CALL UPDATE_CLOTHING_VISIBILITY, 2, 0  ; 被泼水湿透

IF GET_EQUIP(11) == 0  ; 没穿内衣
	PRINTL 学生A：看！乳头都看到了！
	PRINTL 学生B：真的没穿内衣啊...
	PRINTFORML %CALLNAME:(1)%：（抱住胸部）请、请不要看...
	FLAG:100 += 40
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 35, 3
ELSEIF GET_EQUIP(11) == 1106  ; 透明内衣
	PRINTL 学生C：内衣是透明的...都能看到乳头...
	PRINTL 学生D：好色情啊...
	PRINTFORML %CALLNAME:(1)%：（试图遮挡但没用）不、不是这样的...
	FLAG:100 += 32
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 28, 3
ELSE
	PRINTL 女生E：快去换衣服吧，这样太难看了...
	PRINTFORML %CALLNAME:(1)%：谢、谢谢...
	PRINTL 你赶紧跑向更衣室，但一路上很多人都看到了。
	FLAG:100 += 25
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 20, 2
ENDIF

; 湿身状态会持续一段时间
PRINTL 
PRINTL 【你的衣服完全湿透了，需要时间才能干...】
FLAG:96 = 1

WAIT
RETURN

@CLOTHING_DAMAGE_EVENT
; 服装损坏事件
PRINTL 
PRINTL 【你的衣服被什么东西划破了...】
WAIT

LOCAL = RAND:100

IF LOCAL < 50
	; 上衣破损
	GOSUB TOP_DAMAGE_EVENT
ELSE
	; 裙子破损
	GOSUB SKIRT_DAMAGE_EVENT
ENDIF

RETURN

@TOP_DAMAGE_EVENT
; 上衣破损事件
PRINTL 【你的上衣被划开了一个大口子...】
WAIT

PRINTFORML %CALLNAME:(1)%：啊！衣服...
PRINTL 上衣从胸口位置裂开，露出了大片肌肤。
PRINTL 内衣也暴露了出来。
PRINTL 
PRINTL 【你赶紧捂住胸口...】
WAIT

CALL UPDATE_CLOTHING_VISIBILITY, 3, 0  ; 衣服破损

IF GET_EQUIP(11) == 0  ; 没穿内衣
	PRINTL 路人A：天啊！胸部都露出来了！
	PRINTL 路人B：快打电话叫保安！
	PRINTFORML %CALLNAME:(1)%：（蹲下试图遮挡）不要看...求你们...
	FLAG:100 += 45
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 40, 4
ELSE
	PRINTL 女生：快去换件衣服吧，这样太危险了...
	PRINTFORML %CALLNAME:(1)%：谢、谢谢...
	PRINTL 你抱着身体跑向更衣室，破损的上衣几乎遮不住身体。
	FLAG:100 += 35
	CALL APPLY_SEX_EVENT_EFFECTS, 6, 30, 3
ENDIF

; 破损的衣服需要更换
PRINTL 
PRINTL 【你的上衣已经无法再穿了...】
CALL SET_EQUIP, 1, 0  ; 脱掉上衣

WAIT
RETURN

@CHANGE_CLOTHING_MENU
; 更换服装菜单
CLEARLINE 1
PRINTL 【更换服装】
PRINTL 
PRINTL 【当前穿着：{GET_CLOTHING_NAME(GET_EQUIP(1))}+{GET_CLOTHING_NAME(GET_EQUIP(2))}】
PRINTFORML 【当前性感度：{CALCULATE_SEXY_SCORE()} - {GET_SEXY_LEVEL_TEXT()}】
PRINTL 
PRINTL 【请选择服装：】
PRINTL [1] 学生制服（性感度+5）
PRINTL [2] 运动服（性感度+2）
PRINTL [3] 女仆装（性感度+25）
PRINTL [4] 护士服（性感度+18）
PRINTL [5] 泳装（性感度+30）
PRINTL [6] 情趣内衣（性感度+40）
PRINTL [7] 裸体围裙（性感度+45）
PRINTL [8] 透明连衣裙（性感度+38）
PRINTL [9] 比基尼（性感度+35）
PRINTL [0] 返回

$CLOTHING_MENU_CHOICE
INPUT

SELECTCASE RESULT
	CASE 1
		CALL CHANGE_CLOTHING, 40  ; 学生制服
	CASE 2
		CALL CHANGE_CLOTHING, 41  ; 运动服
	CASE 3
		CALL CHANGE_CLOTHING, 43  ; 女仆装
	CASE 4
		CALL CHANGE_CLOTHING, 44  ; 护士服
	CASE 5
		CALL CHANGE_CLOTHING, 46  ; 泳装
	CASE 6
		IF GET_TOTAL_DECLINE_LEVEL() >= 30
			CALL CHANGE_CLOTHING, 47  ; 情趣内衣
		ELSE
			PRINTL 【你的堕落度还不够穿这种衣服...】
			WAIT
		ENDIF
	CASE 7
		IF GET_TOTAL_DECLINE_LEVEL() >= 50
			CALL CHANGE_CLOTHING, 56  ; 裸体围裙
		ELSE
			PRINTL 【你的堕落度还不够穿这种衣服...】
			WAIT
		ENDIF
	CASE 8
		IF GET_TOTAL_DECLINE_LEVEL() >= 40
			CALL CHANGE_CLOTHING, 57  ; 透明连衣裙
		ELSE
			PRINTL 【你的堕落度还不够穿这种衣服...】
			WAIT
		ENDIF
	CASE 9
		IF GET_TOTAL_DECLINE_LEVEL() >= 35
			CALL CHANGE_CLOTHING, 61  ; 比基尼
		ELSE
			PRINTL 【你的堕落度还不够穿这种衣服...】
			WAIT
		ENDIF
	CASE 0
		RETURN
ENDSELECT

; 重新计算性感度
CALL CALCULATE_SEXY_SCORE

; 更换服装可能导致事件
IF RAND:100 < 30
	PRINTL 
	PRINTL 【你换上这套衣服后，感觉周围人的目光都变了...】
	CALL APPLY_SEXY_EFFECTS
ENDIF

WAIT
RETURN

@REST_WITH_CLOTHING
; 休息功能 - 带服装效果
PRINTL 【你选择休息一天】
FLAG:43++  ; 游戏天数

; 身体状态更新
GOSUB DAILY_BODY_UPDATE

; 服装状态更新
GOSUB DAILY_CLOTHING_RESET

; 更新堕落素质
CALL UPDATE_DECLINE_BY_NTR_PROGRESS

PRINTL 时间来到了第二天...

; 检查夜晚事件
IF FLAG:72 == 1  ; 女性线
	GOSUB DECLINE_NIGHT_EVENT
ENDIF

; 检查是否有事件发生
GOSUB CHECK_EVENTS_ENHANCED

; 根据昨天的性感度可能触发事件
IF FLAG:97 >= 80 AND RAND:100 < 20
	PRINTL 
	PRINTL 【昨天你穿得太性感了，今天有人来找你了...】
	GOSUB FOLLOWUP_HARASSMENT_EVENT
ENDIF

WAIT
RETURN

@FOLLOWUP_HARASSMENT_EVENT
; 后续骚扰事件（昨天性感度高的后果）
PRINTL 
PRINTL 【几个男生找到了你...】
WAIT

PRINTL 男生A：昨天看到你了，穿得好性感啊...
PRINTL 男生B：今天怎么不穿了？我们还想看呢。
PRINTL 男生C：再穿一次给我们看看嘛。
PRINTFORML %CALLNAME:(1)%：对、对不起，我要去上课了...
PRINTL 男生A：别急着走啊，聊聊天嘛。
PRINTL 
PRINTL 【他们拦住了你的去路...】
WAIT

; 根据当前穿着决定事件
LOCAL = CALCULATE_SEXY_SCORE()

IF LOCAL >= 60
	GOSUB FOLLOWUP_ADVANCED_HARASSMENT
ELSE
	GOSUB FOLLOWUP_BASIC_HARASSMENT
ENDIF

RETURN

@GET_TOTAL_NTR_PROGRESS
#FUNCTION
LOCAL = (FLAG:75 + FLAG:76 + FLAG:77 + FLAG:78 + FLAG:79 + FLAG:80 + FLAG:81) / 7
RETURNF LOCAL