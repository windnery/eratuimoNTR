; 堕落素质系统
@INIT_DECLINE_SYSTEM
; 初始化堕落素质
IF FLAG:72 == 1  ; 女性线
	; 设置女主初始素质
	CALL SET_CHARA_TALENT, 1, 10, 0   ; 亲密
	CALL SET_CHARA_TALENT, 1, 11, 0   ; 顺从
	CALL SET_CHARA_TALENT, 1, 12, 0   ; 欲望
	CALL SET_CHARA_TALENT, 1, 13, 0   ; 技巧
	CALL SET_CHARA_TALENT, 1, 14, 0   ; 侍奉精神
	CALL SET_CHARA_TALENT, 1, 15, 0   ; 露出癖
	CALL SET_CHARA_TALENT, 1, 30, 0   ; 自慰中毒
	CALL SET_CHARA_TALENT, 1, 31, 0   ; 精液中毒
	CALL SET_CHARA_TALENT, 1, 32, 0   ; 精饮中毒
	CALL SET_CHARA_TALENT, 1, 35, 0   ; 膣射中毒
	CALL SET_CHARA_TALENT, 1, 36, 0   ; 肛射中毒
	CALL SET_CHARA_TALENT, 1, 50, 0   ; 指技
	CALL SET_CHARA_TALENT, 1, 51, 0   ; 舌技
	CALL SET_CHARA_TALENT, 1, 52, 0   ; 胸技
	CALL SET_CHARA_TALENT, 1, 53, 0   ; 腰技
	CALL SET_CHARA_TALENT, 1, 54, 0   ; 膣技
	CALL SET_CHARA_TALENT, 1, 55, 0   ; 菊花技
ENDIF
RETURN

@INCREASE_DECLINE_TALENT, ARG:1, ARG:2
; 增加堕落素质
; ARG:1 = 素质编号
; ARG:2 = 增加量
LOCAL:1 = GET_CHARA_TALENT(1, ARG:1)
LOCAL:1 += ARG:2
CALL SET_CHARA_TALENT, 1, ARG:1, LOCAL:1

; 输出提示信息
IF FLAG:72 == 1
	SELECTCASE ARG:1
		CASE 10
			PRINTL 【你的身体对亲密接触的抵抗力下降了...】
		CASE 11
			PRINTL 【你变得越来越顺从了...】
		CASE 12
			PRINTL 【内心的欲望在逐渐膨胀...】
		CASE 13
			PRINTL 【你对性技巧的了解增加了...】
		CASE 14
			PRINTL 【侍奉他人的意愿在增强...】
		CASE 15
			PRINTL 【你开始不介意被他人注视了...】
		CASE 30
			PRINTL 【自慰的冲动越来越强烈...】
		CASE 31
			PRINTL 【你对精液的味道越来越习惯了...】
		CASE 32
			PRINTL 【吞下精液的欲望在增长...】
		CASE 35
			PRINTL 【体内被射满的感觉让你着迷...】
		CASE 36
			PRINTL 【后穴被侵犯的快感在增强...】
		CASE 50
			PRINTL 【手指的技巧提升了...】
		CASE 51
			PRINTL 【舌头的运用更加熟练了...】
		CASE 52
			PRINTL 【胸部的使用技巧增加了...】
		CASE 53
			PRINTL 【腰部的扭动更加色气了...】
		CASE 54
			PRINTL 【小穴的收缩控制力提升了...】
		CASE 55
			PRINTL 【肛门的适应性增强了...】
	ENDSELECT
ENDIF
RETURN

@CHECK_DECLINE_LEVEL, ARG:1
; 检查堕落等级
; ARG:1 = 素质编号
#FUNCTION
LOCAL = GET_CHARA_TALENT(1, ARG:1)

SELECTCASE LOCAL
	CASE <= 10
		RETURNF 0  ; 未堕落
	CASE <= 30
		RETURNF 1  ; 轻微堕落
	CASE <= 60
		RETURNF 2  ; 中度堕落
	CASE <= 90
		RETURNF 3  ; 重度堕落
	CASEELSE
		RETURNF 4  ; 完全堕落
ENDSELECT

@GET_DECLINE_STATUS_TEXT
; 获取堕落状态文本
#FUNCTION
LOCAL = 0
LOCALS = ""

; 检查各素质等级
IF CHECK_DECLINE_LEVEL(10) >= 2
	LOCALS = %LOCALS%亲密度高
	LOCAL += 1
ENDIF
IF CHECK_DECLINE_LEVEL(11) >= 2
	LOCALS = %LOCALS%顺从性强
	LOCAL += 1
ENDIF
IF CHECK_DECLINE_LEVEL(12) >= 2
	LOCALS = %LOCALS%欲望旺盛
	LOCAL += 1
ENDIF
IF CHECK_DECLINE_LEVEL(30) >= 2
	LOCALS = %LOCALS%自慰成瘾
	LOCAL += 1
ENDIF
IF CHECK_DECLINE_LEVEL(31) >= 2
	LOCALS = %LOCALS%精液依赖
	LOCAL += 1
ENDIF
IF CHECK_DECLINE_LEVEL(35) >= 2
	LOCALS = %LOCALS%内射渴望
	LOCAL += 1
ENDIF

IF LOCAL == 0
	RETURNF "纯洁状态"
ELSEIF LOCAL == 1
	RETURNF %LOCALS%
ELSE
	RETURNF %LOCALS%等{LOCAL}项异常
ENDIF

@UPDATE_DECLINE_BY_NTR_PROGRESS
; 根据NTR进度更新堕落素质
LOCAL = FLAG:75 + FLAG:76 + FLAG:77 + FLAG:78 + FLAG:79 + FLAG:80 + FLAG:81
LOCAL /= 7  ; 平均NTR进度

IF LOCAL >= 10
	; NTR进度10%以上
	CALL INCREASE_DECLINE_TALENT, 10, 1  ; 亲密
	CALL INCREASE_DECLINE_TALENT, 11, 1  ; 顺从
ENDIF
IF LOCAL >= 20
	CALL INCREASE_DECLINE_TALENT, 12, 1  ; 欲望
	CALL INCREASE_DECLINE_TALENT, 13, 1  ; 技巧
ENDIF
IF LOCAL >= 30
	CALL INCREASE_DECLINE_TALENT, 14, 1  ; 侍奉精神
	CALL INCREASE_DECLINE_TALENT, 30, 1  ; 自慰中毒
ENDIF
IF LOCAL >= 40
	CALL INCREASE_DECLINE_TALENT, 31, 1  ; 精液中毒
	CALL INCREASE_DECLINE_TALENT, 35, 1  ; 膣射中毒
ENDIF
IF LOCAL >= 50
	CALL INCREASE_DECLINE_TALENT, 50, 1  ; 指技
	CALL INCREASE_DECLINE_TALENT, 51, 1  ; 舌技
ENDIF
IF LOCAL >= 60
	CALL INCREASE_DECLINE_TALENT, 52, 1  ; 胸技
	CALL INCREASE_DECLINE_TALENT, 53, 1  ; 腰技
ENDIF
IF LOCAL >= 70
	CALL INCREASE_DECLINE_TALENT, 54, 1  ; 膣技
	CALL INCREASE_DECLINE_TALENT, 55, 1  ; 菊花技
ENDIF
IF LOCAL >= 80
	CALL INCREASE_DECLINE_TALENT, 15, 1  ; 露出癖
	CALL INCREASE_DECLINE_TALENT, 36, 1  ; 肛射中毒
ENDIF
RETURN

@VIEW_DECLINE_STATUS
; 查看堕落状态详细
CLEARLINE 1
PRINTL 【堕落状态详细】
PRINTL 
PRINTFORML 堕落状态：{GET_DECLINE_STATUS_TEXT()}
PRINTFORML 总体堕落度：{(GET_TOTAL_DECLINE_LEVEL())}%
PRINTL 
PRINTL 【素质详细：】
PRINTFORML 亲密：{GET_CHARA_TALENT(1, 10)}/{CHECK_DECLINE_LEVEL(10)}级
PRINTFORML 顺从：{GET_CHARA_TALENT(1, 11)}/{CHECK_DECLINE_LEVEL(11)}级
PRINTFORML 欲望：{GET_CHARA_TALENT(1, 12)}/{CHECK_DECLINE_LEVEL(12)}级
PRINTFORML 技巧：{GET_CHARA_TALENT(1, 13)}/{CHECK_DECLINE_LEVEL(13)}级
PRINTFORML 侍奉精神：{GET_CHARA_TALENT(1, 14)}/{CHECK_DECLINE_LEVEL(14)}级
PRINTFORML 露出癖：{GET_CHARA_TALENT(1, 15)}/{CHECK_DECLINE_LEVEL(15)}级
PRINTL 
PRINTL 【中毒症状：】
PRINTFORML 自慰中毒：{GET_CHARA_TALENT(1, 30)}/{CHECK_DECLINE_LEVEL(30)}级
PRINTFORML 精液中毒：{GET_CHARA_TALENT(1, 31)}/{CHECK_DECLINE_LEVEL(31)}级
PRINTFORML 精饮中毒：{GET_CHARA_TALENT(1, 32)}/{CHECK_DECLINE_LEVEL(32)}级
PRINTFORML 膣射中毒：{GET_CHARA_TALENT(1, 35)}/{CHECK_DECLINE_LEVEL(35)}级
PRINTFORML 肛射中毒：{GET_CHARA_TALENT(1, 36)}/{CHECK_DECLINE_LEVEL(36)}级
PRINTL 
PRINTL 【性技等级：】
PRINTFORML 指技：{GET_CHARA_TALENT(1, 50)}/{CHECK_DECLINE_LEVEL(50)}级
PRINTFORML 舌技：{GET_CHARA_TALENT(1, 51)}/{CHECK_DECLINE_LEVEL(51)}级
PRINTFORML 胸技：{GET_CHARA_TALENT(1, 52)}/{CHECK_DECLINE_LEVEL(52)}级
PRINTFORML 腰技：{GET_CHARA_TALENT(1, 53)}/{CHECK_DECLINE_LEVEL(53)}级
PRINTFORML 膣技：{GET_CHARA_TALENT(1, 54)}/{CHECK_DECLINE_LEVEL(54)}级
PRINTFORML 菊花技：{GET_CHARA_TALENT(1, 55)}/{CHECK_DECLINE_LEVEL(55)}级
PRINTL 
PRINTL 【堕落影响：】
IF CHECK_DECLINE_LEVEL(11) >= 2
	PRINTL 你越来越难以拒绝男性的要求...
ENDIF
IF CHECK_DECLINE_LEVEL(12) >= 2
	PRINTL 性幻想时常出现在脑海中...
ENDIF
IF CHECK_DECLINE_LEVEL(30) >= 2
	PRINTL 夜晚时自慰的冲动越来越强烈...
ENDIF
IF CHECK_DECLINE_LEVEL(31) >= 3
	PRINTL 闻到精液的味道会让你兴奋...
ENDIF
IF CHECK_DECLINE_LEVEL(35) >= 3
	PRINTL 体内被射满的快感让你难以自拔...
ENDIF
WAIT
RETURN

@GET_TOTAL_DECLINE_LEVEL
; 计算总体堕落度
#FUNCTION
LOCAL = 0
LOCAL += GET_CHARA_TALENT(1, 10) * 2
LOCAL += GET_CHARA_TALENT(1, 11) * 2
LOCAL += GET_CHARA_TALENT(1, 12) * 3
LOCAL += GET_CHARA_TALENT(1, 13) * 1
LOCAL += GET_CHARA_TALENT(1, 14) * 2
LOCAL += GET_CHARA_TALENT(1, 15) * 3
LOCAL += GET_CHARA_TALENT(1, 30) * 4
LOCAL += GET_CHARA_TALENT(1, 31) * 4
LOCAL += GET_CHARA_TALENT(1, 32) * 5
LOCAL += GET_CHARA_TALENT(1, 35) * 5
LOCAL += GET_CHARA_TALENT(1, 36) * 6
LOCAL += GET_CHARA_TALENT(1, 50) * 1
LOCAL += GET_CHARA_TALENT(1, 51) * 2
LOCAL += GET_CHARA_TALENT(1, 52) * 1
LOCAL += GET_CHARA_TALENT(1, 53) * 2
LOCAL += GET_CHARA_TALENT(1, 54) * 3
LOCAL += GET_CHARA_TALENT(1, 55) * 4

; 最大值为 (10+11+12+13+14+15)*最大权重
; 简化计算，百分比显示
LOCAL = LOCAL * 100 / 300  ; 约300为理论最大值
IF LOCAL > 100
	LOCAL = 100
ENDIF
RETURNF LOCAL

@APPLY_DECLINE_EFFECTS, ARG:1, ARG:2
; 应用堕落效果
; ARG:1 = 事件类型
; ARG:2 = 目标角色
LOCAL = GET_TOTAL_DECLINE_LEVEL()

SELECTCASE ARG:1
	CASE 0  ; 抵抗成功率
		; 堕落度越高，抵抗成功率越低
		LOCAL:1 = 100 - LOCAL / 2
		IF RAND:100 < LOCAL:1
			RETURNF 1  ; 抵抗成功
		ELSE
			RETURNF 0  ; 抵抗失败
		ENDIF
	CASE 1  ; 快感强度
		; 堕落度越高，快感越强
		LOCAL:1 = LOCAL / 10 + 1
		RETURNF LOCAL:1
	CASE 2  ; 羞耻感减弱
		; 堕落度越高，羞耻感越弱
		LOCAL:1 = LOCAL / 20
		RETURNF LOCAL:1
	CASE 3  ; 主动行为概率
		; 堕落度越高，越可能主动
		IF RAND:100 < LOCAL / 2
			RETURNF 1
		ELSE
			RETURNF 0
		ENDIF
ENDSELECT
RETURNF 0

@DECLINE_NIGHT_EVENT
; 夜晚堕落事件
IF FLAG:72 == 1 AND FLAG:44 == 1  ; 女性线且在自由模式
	LOCAL = GET_TOTAL_DECLINE_LEVEL()
	
	IF LOCAL >= 20 AND RAND:100 < 30
		; 自慰事件
		GOSUB NIGHT_MASTURBATION_EVENT
	ELSEIF LOCAL >= 40 AND RAND:100 < 20
		; 性幻想事件
		GOSUB NIGHT_FANTASY_EVENT
	ELSEIF LOCAL >= 60 AND RAND:100 < 15
		; 梦游事件
		GOSUB NIGHT_SLEEPWALK_EVENT
	ENDIF
ENDIF
RETURN

@NIGHT_MASTURBATION_EVENT
; 夜晚自慰事件
PRINTL 
PRINTL 【深夜，你在宿舍里...】
WAIT

LOCAL = CHECK_DECLINE_LEVEL(30)  ; 自慰中毒等级

PRINTL 一种难以抑制的冲动涌上心头...
PRINTL 你的手不自觉地滑向双腿之间...
PRINTL 
IF LOCAL >= 2
	PRINTL 手指熟练地找到敏感点，轻轻揉搓...
	PRINTL 快感迅速蔓延全身，你咬住嘴唇抑制呻吟...
ELSEIF LOCAL >= 1
	PRINTL 你笨拙地触摸着敏感部位，心跳加速...
	PRINTL 一种陌生的快感让你身体微微颤抖...
ELSE
	PRINTL 你感到有些羞耻，但还是忍不住继续...
	PRINTL 这是你第一次做这种事...
ENDIF

PRINTL 
PRINTL 【快感逐渐累积...】
WAIT

IF LOCAL >= 3
	PRINTL 啊...嗯啊...♡
	PRINTL 你熟练地加快速度，身体剧烈颤抖...
	PRINTL 高潮来得又快又猛，你几乎要叫出声来...
	PRINTL 要、要去了啊...❤️
ELSEIF LOCAL >= 2
	PRINTL 嗯...唔...♡
	PRINTL 快感不断攀升，你忍不住发出细微的呻吟...
	PRINTL 身体绷紧，迎来了强烈的高潮...
ELSE
	PRINTL 哈啊...啊...
	PRINTL 一股奇妙的快感涌遍全身，你小声喘息着...
	PRINTL 第一次体验到这种陌生的快感...
ENDIF

PRINTL 
PRINTL 【自慰后，你感到一阵空虚和羞耻...】
PRINTL 但也有一丝满足感...

; 增加堕落素质
CALL INCREASE_DECLINE_TALENT, 30, 2  ; 自慰中毒
CALL INCREASE_DECLINE_TALENT, 12, 1  ; 欲望
FLAG:39 += 3  ; 背德值

WAIT
RETURN

; ... 更多堕落相关事件函数