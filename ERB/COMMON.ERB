; 公共函数库
@COMMON

; 显示消息框
@SHOW_MESSAGE(ARGS)
PRINTL %ARGS%
WAIT
RETURN

; 检查角色是否存在
@CHECK_CHARACTER_EXIST(ARG)
#FUNCTION
IF CHARANUM > ARG && ARG >= 0
	RETURNF 1
ELSE
	RETURNF 0
ENDIF

; 获取角色名称
@GET_CHARACTER_NAME(ARG)
#FUNCTIONS
IF ARG == 0
	RETURNF %NAME:0%
ELSEIF ARG == 1
	RETURNF %NAME:1%
ELSEIF ARG == 2
	RETURNF %NAME:2%
ELSEIF ARG == 3
	RETURNF %NAME:3%
ELSE
	RETURNF "未知角色"
ENDIF

; 使用GETNUM获取变量编号的辅助函数
@GET_BASE_NUM(ARG)
#FUNCTION
RETURNF GETNUM(BASE, ARG)

@GET_PALAM_NUM(ARG)
#FUNCTION
RETURNF GETNUM(PALAM, ARG)

@GET_CFLAG_NUM(ARG)
#FUNCTION
RETURNF GETNUM(CFLAG, ARG)

; 检查NTR条件
@CHECK_NTR_CONDITION(ARG_CHARACTER, ARG_THRESHOLD)
#FUNCTION
SELECTCASE ARG_CHARACTER
	CASE 0  ; 男主视角检查女主NTR
		IF FLAG:75 >= ARG_THRESHOLD || FLAG:76 >= ARG_THRESHOLD || FLAG:77 >= ARG_THRESHOLD  ; NTR进度
			RETURNF 1
		ENDIF
	CASE 1  ; 女主视角检查自身NTR
		LOCAL = (FLAG:75 + FLAG:76 + FLAG:77 + FLAG:78) / 4  ; NTR进度
		IF LOCAL >= ARG_THRESHOLD
			RETURNF 1
		ENDIF
ENDSELECT
RETURNF 0

; 更新NTR进度
@UPDATE_NTR_PROGRESS(ARG_CHARACTER, ARG_VALUE)
SELECTCASE ARG_CHARACTER
	CASE 0
		FLAG:75 += ARG_VALUE  ; NTR进度吴昊
	CASE 1
		FLAG:76 += ARG_VALUE  ; NTR进度佐藤老师
	CASE 2
		FLAG:77 += ARG_VALUE  ; NTR进度学生会长
	CASE 3
		FLAG:78 += ARG_VALUE  ; NTR进度魔物
ENDSELECT
; 限制最大值
FLAG:75 = MIN(FLAG:75, 100)
FLAG:76 = MIN(FLAG:76, 100)
FLAG:77 = MIN(FLAG:77, 100)
FLAG:78 = MIN(FLAG:78, 100)
RETURN

; 检查好感度变化
@CHECK_RELATIONSHIP_CHANGE()
IF FLAG:38 > 70  ; 好感度
	PRINTFORML 【你和%CALLNAME:(1)%的关系变得更好了】
ELSEIF FLAG:38 < 30  ; 好感度
	PRINTFORML 【你和%CALLNAME:(1)%的关系变得疏远了】
ENDIF
RETURN

; 检查背德值变化
@CHECK_CORRUPTION_CHANGE()
IF FLAG:39 > 50  ; 背德值
	PRINTL 【道德观念正在逐渐崩坏...】
ELSEIF FLAG:39 > 80  ; 背德值
	PRINTL 【已经无法回头了...】
ENDIF
RETURN

; 检查游戏结束条件
@CHECK_GAME_END()
IF FLAG:75 >= 100 && FLAG:76 >= 100 && FLAG:77 >= 100 && FLAG:78 >= 100  ; NTR进度
	PRINTL 【游戏结束 - 完全NTR结局】
	RETURN 1
ELSEIF FLAG:38 <= 0  ; 好感度
	PRINTL 【游戏结束 - 关系破裂结局】
	RETURN 1
ELSEIF FLAG:39 >= 100  ; 背德值
	PRINTL 【游戏结束 - 彻底堕落结局】
	RETURN 1
ENDIF
RETURN 0

; 显示选项并获取输入
@SHOW_CHOICES(ARGS:0, ARGS:1, ARGS:2, ARGS:3, ARGS:4)
PRINTL %ARGS:0%
FOR LOCAL, 1, 5
	IF STRLENS(ARGS:LOCAL) > 0
		PRINTFORML [{LOCAL}] %ARGS:LOCAL%
	ENDIF
NEXT
INPUT
RETURN RESULT