; 主系统集成纹身系统
@MAIN_SYSTEM_WITH_TATTOO
; 游戏主循环 - 集成纹身系统

; 初始化检查
IF FLAG:90 == 0
	CALL INIT_DECLINE_SYSTEM
	FLAG:90 = 1
ENDIF

; 服装系统初始化
IF FLAG:91 == 0
	CALL INIT_CLOTHING_SYSTEM
ENDIF

; 纹身系统初始化
IF FLAG:101 == 0
	CALL INIT_TATTOO_SYSTEM
ENDIF

$MAIN_LOOP_TATTOO
CLEARLINE 1
PRINTL 【昙明学院 - 第{FLAG:43}天】
PRINTL 【当前位置：{GET_LOCATION_NAME()}】
PRINTL 【状态：好感度:{FLAG:38} 背德值:{FLAG:39} NTR进度:{GET_TOTAL_NTR_PROGRESS()}%】

; 显示身体状态摘要
IF FLAG:72 == 1  ; 女性线
	PRINTFORML 【身体：胸部{GET_BREAST_SIZE_TEXT(1)} 小穴{GET_VAGINA_SIZE_TEXT(1)} 淫乱度:{GET_PALAM(1, 20)}】
	PRINTFORML 【穿着：{GET_CLOTHING_NAME(GET_EQUIP(1))}+{GET_CLOTHING_NAME(GET_EQUIP(2))} 性感度:{CALCULATE_SEXY_SCORE()}】
	PRINTFORML 【纹身：{FLAG:102}处 媚黑纹身:{FLAG:103}处 穿孔:{GET_PIERCING_COUNT()}处】
ENDIF

PRINTL 
PRINTL 【请选择行动】
PRINTL [1] 探索学院
PRINTL [2] 寻找角色
PRINTL [3] 查看状态
PRINTL [4] 查看身体状态
PRINTL [5] 查看堕落状态
PRINTL [6] 查看服装状态
PRINTL [7] 查看纹身状态
PRINTL [8] 更换服装
PRINTL [9] 休息
PRINTL [0] 返回标题

$MAIN_INPUT_TATTOO
INPUT

IF RESULT == 0
	GOTO SYSTEM_TITLE
ELSEIF RESULT == 1
	GOSUB EXPLORE_COLLEGE_WITH_TATTOO
	CLEARLINE 10
	GOTO MAIN_LOOP_TATTOO
ELSEIF RESULT == 2
	GOSUB FIND_CHARACTER
	CLEARLINE 10
	GOTO MAIN_LOOP_TATTOO
ELSEIF RESULT == 3
	GOSUB VIEW_STATUS_ENHANCED
	CLEARLINE 20
	GOTO MAIN_LOOP_TATTOO
ELSEIF RESULT == 4
	GOSUB VIEW_BODY_STATUS
	CLEARLINE 20
	GOTO MAIN_LOOP_TATTOO
ELSEIF RESULT == 5
	GOSUB VIEW_DECLINE_STATUS
	CLEARLINE 20
	GOTO MAIN_LOOP_TATTOO
ELSEIF RESULT == 6
	GOSUB VIEW_CLOTHING_STATUS
	CLEARLINE 20
	GOTO MAIN_LOOP_TATTOO
ELSEIF RESULT == 7
	GOSUB VIEW_TATTOO_STATUS
	CLEARLINE 20
	GOTO MAIN_LOOP_TATTOO
ELSEIF RESULT == 8
	GOSUB CHANGE_CLOTHING_MENU
	CLEARLINE 10
	GOTO MAIN_LOOP_TATTOO
ELSEIF RESULT == 9
	GOSUB REST_WITH_TATTOO
	CLEARLINE 10
	GOTO MAIN_LOOP_TATTOO
ELSE
	CLEARLINE 1
	GOTO MAIN_INPUT_TATTOO
ENDIF

@EXPLORE_COLLEGE_WITH_TATTOO
; 探索学院 - 带纹身效果
GOSUB EXPLORE_COLLEGE_WITH_CLOTHING

; 应用纹身效果
CALL CALCULATE_TATTOO_EFFECTS
CALL APPLY_TATTOO_TO_EVENTS

; 根据纹身增加特殊事件
IF FLAG:102 >= 3 AND RAND:100 < 20
	; 纹身被注意到事件
	GOSUB TATTOO_NOTICED_EVENT
ENDIF

RETURN

@TATTOO_NOTICED_EVENT
; 纹身被注意到事件
PRINTL 
PRINTL 【有人注意到了你身上的纹身...】
WAIT

LOCAL = RAND:100

IF LOCAL < 40
	; 被路人注意到
	GOSUB TATTOO_PUBLIC_REACTION
ELSEIF LOCAL < 70
	; 被老师注意到
	GOSUB TATTOO_TEACHER_REACTION
ELSE
	; 被不良注意到
	GOSUB TATTOO_DELINQUENT_REACTION
ENDIF

RETURN

@TATTOO_PUBLIC_REACTION
; 公众对纹身的反应
PRINTL 【几个路人盯着你身上的纹身议论...】
WAIT

IF FLAG:103 >= 3  ; 媚黑纹身多
	PRINTL 路人A：看那个女的，身上好多黑桃纹身...
	PRINTL 路人B：是媚黑女吧？专门服务黑人的...
	PRINTL 路人C：真不要脸，中国人还纹那种东西...
	PRINTFORML %CALLNAME:(1)%：（低着头快步走开）
	PRINTL 但他们的议论声还是传进了你的耳朵。
	
	CALL SET_PALAM, 1, 37, MIN(100, GET_PALAM(1, 37) + 8)  ; 罪恶感增加
	CALL SET_PALAM, 1, 16, MIN(100, GET_PALAM(1, 16) + 5)  ; 背德感增加
	
ELSEIF FLAG:102 >= 5  ; 普通纹身多
	PRINTL 女生A：她身上好多纹身啊...
	PRINTL 女生B：看起来像不良少女...
	PRINTL 女生C：我们还是离她远点吧...
	PRINTFORML %CALLNAME:(1)%：（感到被孤立）
	
	CALL SET_PALAM, 1, 40, MIN(100, GET_PALAM(1, 40) + 5)  ; 孤独感增加
	
ELSE
	PRINTL 男生A：纹身挺性感的嘛...
	PRINTL 男生B：是啊，有种坏女人的感觉...
	PRINTL 男生C：要不要去搭讪试试？
	PRINTFORML %CALLNAME:(1)%：（感到不安）
	
	; 可能触发搭讪
	IF RAND:100 < 30
		GOSUB RANDOM_HARASSMENT_EVENT
	ENDIF
ENDIF

WAIT
RETURN

@TATTOO_TEACHER_REACTION
; 老师对纹身的反应
PRINTL 【老师看到了你身上的纹身...】
WAIT

PRINTL 老师：%CALLNAME:(1)%同学，你身上的纹身...
PRINTFORML %CALLNAME:(1)%：对、对不起老师...
PRINTL 老师：学校有规定，学生不能有纹身。
PRINTL 老师：你这个...必须去除。
PRINTFORML %CALLNAME:(1)%：但、但是去除不了...
PRINTL 老师：去除不了？为什么？
PRINTL 你无法解释是被强制纹上的。
PRINTFORML %CALLNAME:(1)%：我、我会想办法的...
PRINTL 老师：一周内必须处理，否则可能要停学处理。
PRINTL 
PRINTL 【你面临着必须去除纹身的压力...】
WAIT

; 增加心理压力
CALL SET_PALAM, 1, 41, MIN(100, GET_PALAM(1, 41) + 10)  ; 不安感增加

; 可能触发去除纹身事件
IF RAND:100 < 40
	PRINTL 
	PRINTL 【你想起了纹身店老板的提议...】
	PRINTL 也许你真的需要想办法去除这些纹身...
	
	; 记录这个事件，可能在后续触发
	FLAG:106 = 1  ; 纹身去除压力标记
ENDIF

RETURN

@REST_WITH_TATTOO
; 休息功能 - 带纹身效果
PRINTL 【你选择休息一天】
FLAG:43++  ; 游戏天数

; 身体状态更新
GOSUB DAILY_BODY_UPDATE

; 服装状态更新
GOSUB DAILY_CLOTHING_RESET

; 更新堕落素质
CALL UPDATE_DECLINE_BY_NTR_PROGRESS

PRINTL 时间来到了第二天...

; 检查夜晚事件
IF FLAG:72 == 1  ; 女性线
	GOSUB DECLINE_NIGHT_EVENT
ENDIF

; 检查是否有事件发生
GOSUB CHECK_EVENTS_ENHANCED

; 根据纹身触发特殊事件
IF FLAG:102 >= 1
	; 纹身疼痛恢复
	PRINTL 【纹身部位的疼痛稍微减轻了一些...】
	
	; 纹身可能感染（概率）
	IF RAND:100 < 10
		GOSUB TATTOO_INFECTION_EVENT
	ENDIF
ENDIF

; 穿孔恢复
IF GET_PIERCING_COUNT() >= 1
	PRINTL 【穿孔部位的肿胀稍微减轻了一些...】
	
	; 穿孔可能感染
	IF RAND:100 < 15
		GOSUB PIERCING_INFECTION_EVENT
	ENDIF
ENDIF

; 纹身去除压力检查
IF FLAG:106 == 1 AND RAND:100 < 30
	PRINTL 
	PRINTL 【你想起老师要求你去除纹身...】
	GOSUB TATTOO_REMOVAL_PRESSURE_EVENT
ENDIF

WAIT
RETURN

@GET_PIERCING_COUNT
; 获取穿孔数量
#FUNCTION
LOCAL = 0
FOR LOCAL:1, 0, 14
	IF GET_PIERCING(1, LOCAL:1) != 0
		LOCAL += 1
	ENDIF
NEXT
RETURNF LOCAL

@CHECK_EVENTS_ENHANCED_WITH_TATTOO
; 检查事件触发 - 增强版（带纹身）
GOSUB CHECK_EVENTS_ENHANCED

; 纹身相关事件
IF FLAG:102 >= 5 AND FLAG:107 == 0
	PRINTL 【你身上的纹身开始影响你的日常生活...】
	PRINTL 人们看你的眼神都变了...
	FLAG:107 = 1
ELSEIF FLAG:103 >= 3 AND FLAG:108 == 0
	PRINTL 【媚黑纹身让你在黑人群中更受欢迎...】
	PRINTL 更多的黑人开始注意到你...
	FLAG:108 = 1
ELSEIF FLAG:104 >= 2 AND FLAG:109 == 0
	PRINTL 【奴隶纹身标志着你是容易控制的...】
	PRINTL 有些人开始打你的主意...
	FLAG:109 = 1
ENDIF

RETURN

@GET_TOTAL_NTR_PROGRESS_WITH_TATTOO
#FUNCTION
LOCAL = (FLAG:75 + FLAG:76 + FLAG:77 + FLAG:78 + FLAG:79 + FLAG:80 + FLAG:81) / 7

; 纹身增加NTR进度（永久标记）
LOCAL += FLAG:102 / 10  ; 每个纹身+0.1%
LOCAL += FLAG:103 / 5   ; 每个媚黑纹身+0.2%
LOCAL += GET_PIERCING_COUNT() / 20  ; 每个穿孔+0.05%

RETURNF LOCAL