; 存档/读档系统
@SAVE_LOAD_SYSTEM
; 存档主菜单

DRAWLINE
PRINTFORML 存档/读档系统
DRAWLINE

PRINTL 【请选择操作：】
PRINTL [1] 保存游戏
PRINTL [2] 读取存档
PRINTL [0] 返回主菜单
PRINTL 

$SAVE_MENU_CHOICE
INPUT

IF RESULT == 0
	RETURN
ELSEIF RESULT == 1
	CALL SAVE_GAME_MENU
ELSEIF RESULT == 2
	CALL LOAD_GAME_MENU
ELSE
	CLEARLINE 1
	GOTO SAVE_MENU_CHOICE
ENDIF

; 返回存档菜单
RESTART

; --------------------------------------------------
; 保存游戏菜单
@SAVE_GAME_MENU
DRAWLINE
PRINTFORML 保存游戏
DRAWLINE

; 检查所有存档位状态
FOR LOCAL, 0, 20
	CHKDATA LOCAL
	; CHKDATA是读取数据时返回0 有点奇怪
	IF RESULT == 0
		; 存档可用
		LOCALS:LOCAL = %RESULTS%
	ELSE
		; 空存档位
		LOCALS:LOCAL = ----
	ENDIF
NEXT

$SAVE_SHOW_LOOP
FOR LOCAL, 0, 20
	IF LOCALS:LOCAL != "----"
		RESETCOLOR
	ELSE
		SETCOLOR 8421504  ; 灰色，表示不可选
	ENDIF
	PRINTFORML [{LOCAL, 3, LEFT}] %LOCALS:LOCAL%
NEXT
RESETCOLOR

DRAWLINE
PRINTFORML [999] 返回
PRINTL 

$SAVE_INPUT
INPUT

; 处理返回
IF RESULT == 999
	RETURN
ENDIF

; 处理存档
IF INRANGE(RESULT, 0, 19)
	LOCAL = RESULT
	IF LOCALS:LOCAL != "----"
		PRINTFORML  {LOCAL}号位置已有存档，是否覆盖？
		PRINTL [1] 是 [0] 否
		INPUT
		IF RESULT == 0
			GOTO SAVE_SHOW_LOOP
		ENDIF
	ENDIF
	
	; 生成存档名称
	CALL CREATE_SAVE_NAME()
	
	; 保存游戏
	SAVEDATA LOCAL, RESULTS
	PRINTFORML 已保存至 {LOCAL}号位置
	WAIT
	
	; 重新检查存档状态并刷新显示
	CHKDATA LOCAL
	IF RESULT == 0
		; 更新存档名称
		LOCALS:LOCAL = %RESULTS%
	ENDIF
	
	CLEARLINE 20
	GOTO SAVE_SHOW_LOOP
ELSE
	CLEARLINE 1
	GOTO SAVE_INPUT
ENDIF

RETURN

; --------------------------------------------------
; 读取游戏菜单
@LOAD_GAME_MENU
DRAWLINE
PRINTFORML 读取存档
DRAWLINE

; 检查所有存档位状态
FOR LOCAL, 0, 20
	CHKDATA LOCAL
	; CHKDATA是读取数据时返回0 有点奇怪
	IF RESULT == 0
		; 存档可用
		LOCALS:LOCAL = %RESULTS%
	ELSE
		; 无存档
		LOCALS:LOCAL = ----
	ENDIF
NEXT

$LOAD_SHOW_LOOP
FOR LOCAL, 0, 20
	IF LOCALS:LOCAL != "----"
		RESETCOLOR
	ELSE
		SETCOLOR 8421504  ; 灰色，表示不可选
	ENDIF
	PRINTFORML [{LOCAL, 3, LEFT}] %LOCALS:LOCAL%
NEXT
RESETCOLOR

DRAWLINE
PRINTFORML [999] 返回
PRINTL 

$LOAD_INPUT
INPUT

; 处理返回
IF RESULT == 999
	RETURN
ENDIF

; 处理读档
IF INRANGE(RESULT, 0, 19)
	LOCAL = RESULT
	IF LOCALS:LOCAL == "----"
		PRINTL 该位置没有存档！
		WAIT
		CLEARLINE 25
		GOTO LOAD_SHOW_LOOP
	ENDIF
	
	; 加载游戏
	LOADDATA LOCAL
	CLEARLINE 10
	GOTO MAIN_MENU
ELSE
	CLEARLINE 1
	GOTO LOAD_INPUT
ENDIF

RETURN

; --------------------------------------------------
; 生成存档名称
@CREATE_SAVE_NAME()
#DIMS 存档名称

; 简单的存档名称
GETTIME
存档名称 = %RESULTS% 存档

RESULTS = %存档名称%
RETURN